# Http缓存

定义：
HTTP缓存是客户端和服务端通信的一种缓存，可以将网页访问产生的数据缓存到内存或本地。
所谓浏览器缓存其实就是指在本地使用的计算机中开辟一个内存区，同时也开辟一个硬盘区作为数据传输的缓冲区，然后用这个缓冲区来暂时保存用户以前访问过的信息
方式：
HTTP 缓存主要是通过请求和响应报文头中的对应 Header 信息，来控制缓存的策略
用途：
合理利用可以提升资源重复利用率，减少网络带宽，降低服务器压力，提升客户端响应速度

## 强缓存

定义：当命中强缓存的时候，客户端不会再请求服务器，直接从缓存中读取内容，并返回HTTP状态码200。

方法：
强制缓存，在响应头由 Expires、Cache-Control 和 Pragma控制

#### Expires：HTTP1.0的属性属性，值为服务器返回的过期时间，浏览器再次加载资源时，如果在这个过期时间内，则命中强缓存。

缺点是客户端和服务器时间不一致会导致命中误差

#### Cache-Control：HTTP1.1属性，优先级更高，可以组合使用多种指令，多个指令之间可以通过 “,” 分隔，以下为常用属性

- no-store： 禁用缓存
- no-cache：不使用强缓存，每次需向服务器验证缓存是否失效
- public：表示可以被任何节点缓存，包括客户端和公共缓存服务器
- private：表示该资源只能被客户端（浏览器）缓存
- max-age=：max-age是距离请求发起的时间的秒数，给出了缓存的**相对时间**，单位为**秒**，即获得响应之后多少秒后过期，和Expires同时出现时，max-age优先级更高
- s-maxage：对公共缓存服务器生效，表示该资源在公共服务器中缓存的相对时间。如果存在公共缓存服务器，浏览器缓存失效后，会先请求公共缓存服务器，公共缓存服务器失效后会重新请求资源服务器更新公共缓存服务器中的资源，然后返回给浏览器
- must-revalidate：在缓存过期前可以使用，过期后必须向服务器验证

#### Pragma

- no-cache：效果和cache-control等no-cache一致。

不缓存优先级Pragma > Cache-Control > Expires

强缓存的资源存储位置
(下表罗列了chrome 开发着工具中 network标签下资源请求表中信息)
| 状态 Status | Network - Size | 含义 |
| ---- | -------------- | ---------------------------------------------------------------------------- |
| 200 | memory cache | 不请求网络资源，资源在内存，一般是脚本、字体、图片，浏览器关闭，数据将被释放 |
| 200 | disk cache | 请求网络资源，资源在磁盘，一般是css等，关闭数据还在 |
| 200 | 资源大小 | 从服务器下载最新资源 |
| 304 | 报文大小 | 请求服务端发现资源未更新，使用本地资源 |

## 协商缓存

协商缓存是在强缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识来决定是否使用缓存，如果使用，则返回304状态码并带上新的响应头通知浏览器从缓存中读取资源

响应头中有两个字段标记规则

- Last-Modified / If-Modified-Since

  - Last-Modified是浏览器第一次请求资源，服务器响应头字段，是资源文件最后一次的更改时间(精确到秒)。
  - 下一次发送请求时，请求头里的**If-Modified-Since**就是之前的**Last-Modified**
  - 服务器更加最后修改时间判断命中，如果命中，http为304且不返回资源、不返回**Last-Modified**

- Etag / If-None-Match：**Etag 的校验优先级高于 Last-Modified**

  - Etag是加载资源时，服务器返回的响应头字段，是对资源的唯一标记，值是hash码。
  - 浏览器在下一次加载资源向服务器发送请求时，会将上一次返回的Etag值放到请求头里的**If-None-Match**里
    服务器接受到**If-None-Match**的值后，会拿来跟该资源文件的Etag值做比较，如果相同，则表示资源文件没有发生改变，命中协商缓存。

## 启发式缓存

缓存有效期由Expires和Cache-Control中的max-age来决定的，如果响应头中不存在用来确定强缓存时间的字段时，浏览器会触发启发式缓存，缓存有效期计算公式：
**(date - last-modified ) \* 10%，**
取响应报头中 Date (_创建报文的日期时间_) 与 Last-Modified 值之差的百分之十作为缓存时间。

只有在没有明确缓存策略时，会激活启发式缓存。所以要合理设置缓存，否则会因没有设置缓存时间等原因，导致内容缓存不刷新

# 不缓存方法

## html文件设置meta；

```javascript
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
<meta http-equiv="expires" content="Wed, 26 Feb 1997 00:00:00 GMT">
```

## 服务端响应添加Cache-Control:no-cache,must-revalidate指令

## 修改请求头If-modified-since:0或If-none-match

## 请求url后增加时间戳

## 服务端设置Cache-Control:private指令，防止代理服务器缓存资源

## 相关问题

### 为什么同一个资源有时是from memory cache有时是from disk cache

Chrome会根据本地内存的使用率来决定缓存存放在哪，如果内存使用率很高，放在磁盘里面，内存的使用率很高会暂时放在内存里面

### Cache-Control: max-age=0 和 no-cache有什么不同

max-age=0和no-cache应该是从语义上不同。
max-age=0是告诉客户端资源的缓存到期应该向服务器验证缓存的有效性。
而no-cache则告诉客户端使用缓存前必须向服务器验证缓存的有效性。
